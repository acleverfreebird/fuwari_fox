---
/**
 * Umami æµè§ˆé‡æ˜¾ç¤ºç»„ä»¶
 * æ”¯æŒæ˜¾ç¤ºæ€»æµè§ˆé‡å’Œå•é¡µæµè§ˆé‡
 */
import { umamiStatsConfig } from "@/config";

interface Props {
	type?: "total" | "page"; // æ˜¾ç¤ºç±»å‹: total=æ€»æµè§ˆé‡, page=é¡µé¢æµè§ˆé‡
	url?: string; // é¡µé¢URL (type=pageæ—¶å¿…éœ€)
	showVisitors?: boolean; // æ˜¯å¦æ˜¾ç¤ºè®¿é—®è€…æ•°é‡
	class?: string;
}

const {
	type = "total",
	url,
	showVisitors = true,
	class: className,
} = Astro.props;

// å¦‚æœæœªå¯ç”¨ç»Ÿè®¡åŠŸèƒ½,ä¸æ¸²æŸ“ç»„ä»¶
if (!umamiStatsConfig.enable) {
	return null;
}

// å¦‚æœæ˜¯é¡µé¢æµè§ˆé‡ä½†æœªæä¾›URL,ä¸æ¸²æŸ“
if (type === "page" && !url) {
	console.warn("UmamiPageViews: type='page' requires url prop");
	return null;
}

// ç”Ÿæˆå”¯ä¸€IDç”¨äºDOMæ“ä½œ
const componentId = `umami-views-${Math.random().toString(36).slice(2, 11)}`;
---

<div class:list={["umami-page-views", className]} id={componentId} data-type={type} data-url={url} data-show-visitors={showVisitors}>
	<div class="stat-item pageviews-item">
		<span class="label">æµè§ˆé‡:</span>
		<span class="views-count">
			<span class="loading">...</span>
			<span class="count" style="display: none;">0</span>
			<span class="error" style="display: none;">--</span>
		</span>
	</div>
	{showVisitors && (
		<div class="stat-item visitors-item">
			<span class="label">è®¿å®¢æ•°é‡:</span>
			<span class="visitors-count">
				<span class="loading">...</span>
				<span class="count" style="display: none;">0</span>
			</span>
		</div>
	)}
</div>

<script>
	import { umamiStatsConfig } from "@/config";

	interface ViewsData {
		pageviews?: number;
		total?: number;
		visitors?: number;
		error?: string;
	}

	/**
	 * æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
	 */
	function formatNumber(num: number): string {
		return num.toLocaleString();
	}

	/**
	 * è·å–æµè§ˆé‡æ•°æ®
	 */
	async function fetchPageViews(type: string, url?: string): Promise<ViewsData> {
		try {
			let apiUrl = `${umamiStatsConfig.apiUrl}/stats/total`;
			if (type === "page" && url) {
				apiUrl = `${umamiStatsConfig.apiUrl}/stats/page?url=${encodeURIComponent(url)}`;
			}

			console.log("ğŸ“Š Fetching stats from:", apiUrl);
			
			const response = await fetch(apiUrl, {
				method: 'GET',
				headers: {
					'Accept': 'application/json',
				},
				cache: 'no-cache'
			});
			
			if (!response.ok) {
				throw new Error(`HTTP ${response.status}: ${response.statusText}`);
			}

			const data = await response.json();
			console.log("âœ… Stats received:", data);
			return data;
		} catch (error) {
			console.error("âŒ Failed to fetch stats:", error);
			return { error: (error as Error).message };
		}
	}

	/**
	 * æ›´æ–°æ˜¾ç¤º
	 */
	function updateDisplay(container: HTMLElement, data: ViewsData) {
		console.log("ğŸ”„ Updating display with data:", data);
		
		// è·å–æµè§ˆé‡ç›¸å…³å…ƒç´ 
		const pageviewsItem = container.querySelector(".pageviews-item");
		if (!pageviewsItem) {
			console.error("âŒ pageviews-item not found");
			return;
		}

		const viewsLoading = pageviewsItem.querySelector(".loading") as HTMLElement;
		const viewsCount = pageviewsItem.querySelector(".count") as HTMLElement;
		const viewsError = pageviewsItem.querySelector(".error") as HTMLElement;

		// éšè—åŠ è½½çŠ¶æ€
		if (viewsLoading) viewsLoading.style.display = "none";

		// å¤„ç†é”™è¯¯
		if (data.error) {
			console.error("âŒ Error in data:", data.error);
			if (viewsError) viewsError.style.display = "inline";
			if (viewsCount) viewsCount.style.display = "none";
			return;
		}

		// è·å–æµè§ˆé‡æ•°å€¼ (ä¼˜å…ˆä½¿ç”¨ pageviewsï¼Œå…¶æ¬¡ total)
		const viewCount = data.pageviews ?? data.total ?? 0;
		console.log("ğŸ“ˆ View count:", viewCount);

		// æ›´æ–°æµè§ˆé‡æ˜¾ç¤º
		if (viewsCount) {
			viewsCount.textContent = formatNumber(viewCount);
			viewsCount.style.display = "inline";
			if (viewsError) viewsError.style.display = "none";
			console.log("âœ… Pageviews updated to:", viewCount);
		}

		// æ›´æ–°è®¿å®¢æ•°é‡
		const showVisitors = container.getAttribute("data-show-visitors") === "true";
		if (showVisitors && data.visitors !== undefined) {
			const visitorsItem = container.querySelector(".visitors-item");
			if (visitorsItem) {
				const visitorsLoading = visitorsItem.querySelector(".loading") as HTMLElement;
				const visitorsCount = visitorsItem.querySelector(".count") as HTMLElement;

				if (visitorsLoading) visitorsLoading.style.display = "none";
				if (visitorsCount) {
					visitorsCount.textContent = formatNumber(data.visitors);
					visitorsCount.style.display = "inline";
					console.log("âœ… Visitors updated to:", data.visitors);
				}
			}
		}
	}

	/**
	 * åˆå§‹åŒ–å•ä¸ªç»„ä»¶
	 */
	async function initComponent(container: HTMLElement) {
		const type = container.getAttribute("data-type") || "total";
		const url = container.getAttribute("data-url") || undefined;

		console.log("ğŸš€ Initializing component:", { type, url });

		try {
			const data = await fetchPageViews(type, url);
			updateDisplay(container, data);
		} catch (error) {
			console.error("âŒ Error initializing component:", error);
			updateDisplay(container, { error: (error as Error).message });
		}
	}

	/**
	 * åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
	 */
	function initAllComponents() {
		if (!umamiStatsConfig.enable) {
			console.log("âš ï¸ Umami stats disabled");
			return;
		}

		console.log("ğŸ” Looking for .umami-page-views components");
		const containers = document.querySelectorAll(".umami-page-views");
		console.log(`ğŸ“¦ Found ${containers.length} component(s)`);

		containers.forEach((container) => {
			initComponent(container as HTMLElement);
		});
	}

	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initAllComponents);
	} else {
		// DOM å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
		initAllComponents();
	}

	// æ”¯æŒ Astro é¡µé¢å¯¼èˆª
	document.addEventListener("astro:page-load", initAllComponents);
</script>

<style>
	.umami-page-views {
		display: inline-flex;
		align-items: center;
		gap: 1.5rem;
		font-size: 0.875rem;
		color: var(--color-text-secondary, #666);
	}

	.stat-item {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
	}

	.label {
		font-size: 0.875rem;
		opacity: 0.9;
		font-weight: 500;
	}

	.views-count,
	.visitors-count {
		font-variant-numeric: tabular-nums;
		font-weight: 600;
		color: var(--color-text-primary, #333);
	}

	.loading {
		opacity: 0.6;
		font-size: 0.75rem;
	}

	.error {
		opacity: 0.4;
	}

	/* æ·±è‰²æ¨¡å¼æ”¯æŒ */
	:global(.dark) .umami-page-views {
		color: var(--color-text-secondary-dark, #999);
	}

	:global(.dark) .views-count,
	:global(.dark) .visitors-count {
		color: var(--color-text-primary-dark, #eee);
	}
</style>