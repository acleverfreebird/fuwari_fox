---
import { getImage } from "astro:assets";
import defaultBanner from "../assets/images/banner.png";

// Schema.org 结构化数据类型定义
interface SchemaOrgData {
	"@context": string;
	"@type": string;
	headline: string;
	description: string;
	author: {
		"@type": string;
		name: string;
		url: string;
		sameAs: string[];
	};
	publisher: {
		"@type": string;
		name: string;
		logo: {
			"@type": string;
			url: string;
			width: number;
			height: number;
		};
		sameAs: string[];
	};
	mainEntityOfPage: {
		"@type": string;
		"@id": string;
	};
	url: string;
	image: {
		"@type": string;
		url: string;
		width: number;
		height: number;
	};
	inLanguage: string;
	datePublished?: string;
	dateModified?: string;
	keywords?: string;
	articleSection?: string;
	timeRequired?: string;
}
interface Props {
	title?: string;
	description?: string;
	image?: string | ImageMetadata; // Can be string or ImageMetadata
	article?: boolean;
	publishedTime?: Date;
	modifiedTime?: Date;
	tags?: string[];
	category?: string;
	readingTime?: number;
	noindex?: boolean;
}

const {
	title,
	description,
	image,
	article = false,
	publishedTime,
	modifiedTime,
	tags = [],
	category,
	readingTime,
	noindex = false,
} = Astro.props;

// 构建页面标题
let pageTitle = title
	? `${title} | freebird2913技术博客`
	: "freebird2913技术博客 - 专注编程学习与数码科技分享";

// 构建页面描述
let pageDescription =
	description ||
	"freebird2913的个人技术博客，专注编程学习、数码科技分享。记录技术成长历程，分享实用编程技巧和数码设备使用心得。";

// 构建关键词
let keywords = ["freebird2913", "技术博客", "编程学习", "数码科技"];
if (tags.length > 0) {
	keywords = [...keywords, ...tags];
}
if (category) {
	keywords.push(category);
}

// 构建图片URL
let imageToProcess = image || defaultBanner;
if (typeof imageToProcess === "string" && !imageToProcess.startsWith("http")) {
	// This case should no longer happen for the banner with the fix in [...page].astro
	// but as a fallback, we'll use the default banner.
	imageToProcess = defaultBanner;
}

const optimizedImageSrc =
	typeof imageToProcess === "string"
		? imageToProcess // It's an external URL
		: (
				await getImage({
					src: imageToProcess,
					width: 1200,
					height: 630,
					format: "webp",
				})
			).src;

const ogImage = new URL(optimizedImageSrc, Astro.site).href;

// 增强的结构化数据
const structuredData: SchemaOrgData = {
	"@context": "https://schema.org",
	"@type": article ? "BlogPosting" : "WebPage",
	headline: title || pageTitle,
	description: pageDescription,
	author: {
		"@type": "Person",
		name: "freebird2913",
		url: "https://www.freebird2913.tech",
		sameAs: [
			"https://github.com/acleverfreebird",
			"https://linux.do/u/freebird2913/summary",
		],
	},
	publisher: {
		"@type": "Organization",
		name: "freebird2913技术博客",
		logo: {
			"@type": "ImageObject",
			url: new URL("/assets/images/avatar.png", Astro.site).href,
			width: 512,
			height: 512,
		},
		sameAs: ["https://github.com/acleverfreebird"],
	},
	mainEntityOfPage: {
		"@type": "WebPage",
		"@id": Astro.url.href,
	},
	url: Astro.url.href,
	image: {
		"@type": "ImageObject",
		url: ogImage,
		width: 1200,
		height: 630,
	},
	inLanguage: "zh-CN",
};

if (article && publishedTime) {
	structuredData.datePublished = publishedTime.toISOString();
}

if (article && modifiedTime) {
	structuredData.dateModified = modifiedTime.toISOString();
} else if (article && publishedTime) {
	structuredData.dateModified = publishedTime.toISOString();
}

if (article && tags.length > 0) {
	structuredData.keywords = tags.join(", ");
}

if (article && category) {
	structuredData.articleSection = category;
}

if (article && readingTime) {
	structuredData.timeRequired = `PT${readingTime}M`;
}

// 添加面包屑导航结构化数据
const breadcrumbData = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	itemListElement: [
		{
			"@type": "ListItem",
			position: 1,
			name: "首页",
			item: new URL("/", Astro.site).href,
		},
	],
};

if (article) {
	breadcrumbData.itemListElement.push({
		"@type": "ListItem",
		position: 2,
		name: "文章",
		item: new URL("/archive", Astro.site).href,
	});

	if (category) {
		breadcrumbData.itemListElement.push({
			"@type": "ListItem",
			position: 3,
			name: category,
			item: Astro.url.href,
		});
	}
}
---

<!-- 基础SEO Meta标签 -->
<title>{pageTitle}</title>
<meta name="description" content={pageDescription} />
<meta name="keywords" content={keywords.join(', ')} />
<meta name="author" content="freebird2913" />
<meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"} />
<meta name="googlebot" content={noindex ? "noindex, nofollow" : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"} />

<!-- 增强的SEO Meta标签 -->
<meta name="theme-color" content="#2563eb" />
<meta name="language" content="zh-CN" />
<meta name="revisit-after" content="3 days" />
<meta name="rating" content="General" />
<meta name="distribution" content="Global" />
<meta name="copyright" content="© 2025 freebird2913技术博客" />
<meta name="generator" content="Astro" />
{article && readingTime && <meta name="reading-time" content={`${readingTime} min`} />}

<!-- 性能优化标签 -->
<meta name="preload" content="font" />
<meta name="referrer" content="strict-origin-when-cross-origin" />
<meta name="color-scheme" content="light dark" />

<!-- Core Web Vitals优化提示 -->
<meta name="resource-loading" content="async" />

<!-- Open Graph 标签 -->
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:type" content={article ? "article" : "website"} />
<meta property="og:url" content={Astro.url} />
<meta property="og:site_name" content="freebird2913技术博客" />
<meta property="og:image" content={ogImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content="freebird2913技术博客" />
<meta property="og:locale" content="zh_CN" />

{article && publishedTime && (
  <meta property="article:published_time" content={publishedTime.toISOString()} />
)}
{article && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime.toISOString()} />
)}
{article && category && (
  <meta property="article:section" content={category} />
)}
{article && tags.map(tag => (
  <meta property="article:tag" content={tag} />
))}

<!-- Twitter Card 标签 -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />
<meta name="twitter:image" content={ogImage} />
<meta name="twitter:image:alt" content="freebird2913技术博客" />
<meta name="twitter:creator" content="@freebird2913" />
<meta name="twitter:site" content="@freebird2913" />

<!-- 结构化数据 -->
<script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />
<script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />

<!-- 网站配置结构化数据 -->
{!article && (
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "freebird2913技术博客",
    "url": new URL("/", Astro.site).href,
    "description": "freebird2913的个人技术博客，专注编程学习、数码科技分享",
    "inLanguage": "zh-CN",
    "author": {
      "@type": "Person",
      "name": "freebird2913"
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": new URL("/search?q={search_term_string}", Astro.site).href,
      "query-input": "required name=search_term_string"
    }
  })} />
)}

<!-- 百度站长验证和其他搜索引擎优化 -->
<meta name="baidu-site-verification" content="codeva-YgUfO4i3q7" />
<meta name="google-site-verification" content="your_google_verification_code" />
<meta name="msvalidate.01" content="your_bing_verification_code" />

<!-- 必应搜索引擎优化 -->
<meta name="bingbot" content="index, follow" />
<meta name="slurp" content="index, follow" />

<!-- DNS预解析 -->
<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//www.google-analytics.com" />

<!-- 预连接 -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- RSS 订阅链接 -->
<link rel="alternate" type="application/rss+xml" title="freebird2913技术博客 RSS订阅" href={new URL('/rss.xml', Astro.site).href} />

<!-- Sitemap -->
<link rel="sitemap" type="application/xml" href={new URL('/sitemap.xml', Astro.site).href} />

<!-- Canonical URL -->
<link rel="canonical" href={Astro.url} />

<!-- 移动端优化 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="format-detection" content="telephone=no" />

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json" />

<!-- Favicon 图标 - 搜索引擎优化 -->
<link rel="icon" href="/favicon.ico" sizes="any" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-light-32.png" />
<link rel="icon" type="image/png" sizes="128x128" href="/favicon/favicon-light-128.png" />
<link rel="icon" type="image/png" sizes="192x192" href="/favicon/favicon-light-192.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon-light-180.png" />
<link rel="shortcut icon" href="/favicon.ico" />

<!-- 性能优化 - 关键资源预加载 -->
<link rel="preload" href={ogImage} as="image" fetchpriority="high" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" as="style" />

<!-- 图片优化提示 -->
<meta name="image-loading" content="lazy" />
<meta name="image-decoding" content="async" />

<!-- 预取重要页面 -->
<link rel="prefetch" href="/about/" />
<link rel="prefetch" href="/archive/" />
<link rel="prefetch" href="/friends/" />