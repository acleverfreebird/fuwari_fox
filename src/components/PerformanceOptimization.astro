---
// æ€§èƒ½ä¼˜åŒ–ç»„ä»¶ - ä¸“æ³¨äºCore Web Vitalsä¼˜åŒ–
---

<!-- Critical Resource Hints - ä¼˜åŒ–é¦–å±æ¸²æŸ“ -->
<!-- Bannerå›¾ç‰‡é¢„åŠ è½½ä½¿ç”¨åŠ¨æ€è·¯å¾„é¿å…404 -->
<link rel="preload" href="/_astro/banner.png" as="image" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" as="style" />

<!-- ä¼˜åŒ–å­—ä½“åŠ è½½ - å‡å°‘Layout Shift -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- ä¼˜åŒ–å›¾ç‰‡åŠ è½½ -->
<style>
/* å­—ä½“æ˜¾ç¤ºç­–ç•¥ä¼˜åŒ– - ä½¿ç”¨Google Fontsé¿å…æœ¬åœ°å­—ä½“é—®é¢˜ */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

/* å›¾ç‰‡æ‡’åŠ è½½ä¼˜åŒ– */
img {
	loading: lazy;
	decoding: async;
}

/* å…³é”®å›¾ç‰‡ç«‹å³åŠ è½½ */
#banner img,
.avatar img,
.post-cover img {
	loading: eager;
	decoding: sync;
}

/* ç§»é™¤å¯èƒ½å¯¼è‡´CSSè§£æé”™è¯¯çš„å±æ€§ */
@supports (font-display: swap) {
  .font-roboto {
    font-family: 'Roboto', sans-serif;
  }
}

/* å‡å°‘ç´¯ç§¯å¸ƒå±€åç§» (CLS) */
.onload-animation {
	animation-fill-mode: both;
	will-change: opacity, transform;
}

/* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
.smooth-scroll {
	scroll-behavior: smooth;
}

/* ä¼˜åŒ–CSSåŠ¨ç”»æ€§èƒ½ */
.transition-optimized {
	transform: translateZ(0); /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
	backface-visibility: hidden;
	perspective: 1000;
}
</style>

<!-- é¢„åŠ è½½å…³é”®é¡µé¢ -->
<script>
// é¢„åŠ è½½é‡è¦é¡µé¢ä»¥æå‡å¯¼èˆªé€Ÿåº¦
const criticalPages = ['/about/', '/archive/', '/friends/'];
const observer = new IntersectionObserver((entries) => {
	entries.forEach(entry => {
		if (entry.isIntersecting) {
			criticalPages.forEach(page => {
				const link = document.createElement('link');
				link.rel = 'prefetch';
				link.href = page;
				document.head.appendChild(link);
			});
			observer.disconnect();
		}
	});
});

// å½“ä¸»è¦å†…å®¹åŒºåŸŸè¿›å…¥è§†å£æ—¶å¼€å§‹é¢„åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
	const mainContent = document.querySelector('main');
	if (mainContent) observer.observe(mainContent);
});
</script>

<!-- Service Workeræ³¨å†Œ - ç¼“å­˜ç­–ç•¥ä¼˜åŒ– -->
<script>
if ('serviceWorker' in navigator) {
 	window.addEventListener('load', () => {
 		navigator.serviceWorker.register('/sw.js')
 			.then(registration => {
 				console.log('SW registered: ', registration);
 			})
 			.catch(registrationError => {
 				console.log('SW registration failed: ', registrationError);
 			});
 	});
}
</script>

<!-- æ€§èƒ½ç›‘æ§ -->
<script is:inline>
(function() {
  // æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  window.addEventListener('load', function() {
    setTimeout(function() {
      const perfData = performance.getEntriesByType('navigation')[0];

      if (perfData) {
        const metrics = {
          dns: perfData.domainLookupEnd - perfData.domainLookupStart,
          tcp: perfData.connectEnd - perfData.connectStart,
          response: perfData.responseEnd - perfData.requestStart,
          dom: perfData.domContentLoadedEventEnd - perfData.navigationStart,
          load: perfData.loadEventEnd - perfData.navigationStart,
          fcp: performance.getEntriesByName('first-contentful-paint')[0]?.startTime || 0,
          lcp: performance.getEntriesByName('largest-contentful-paint')[0]?.startTime || 0
        };

        console.log('ğŸš€ Performance Metrics:', metrics);

        // å‘é€åˆ°åˆ†ææœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
        // fetch('/api/performance', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(metrics)
        // });
      }
    }, 1000);
  });

  // é”™è¯¯ç›‘æ§
  window.addEventListener('error', function(event) {
    console.error('ğŸš¨ Global Error:', {
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      error: event.error
    });
  });

  window.addEventListener('unhandledrejection', function(event) {
    console.error('ğŸš¨ Unhandled Promise Rejection:', event.reason);
  });
})();
</script>